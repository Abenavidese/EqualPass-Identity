<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ZK-Scholar - Demo WebAuthn + ZK</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .warning {
        background-color: #fff3cd;
        border-color: #ffeaa7;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }
      input {
        width: 300px;
        padding: 8px;
        margin: 5px;
      }
      .demo-section {
        background: #e9ecef;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
      .fraud-demo {
        background: #ffe6e6;
        border: 2px solid #ff4444;
      }
    </style>
  </head>
  <body>
    <h1>üõ°Ô∏è ZK-Scholar - Demo Seguridad WebAuthn + ZK</h1>

    <div class="section">
      <h2>üë§ Informaci√≥n del Usuario</h2>
      <input
        type="text"
        id="userAddress"
        placeholder="Direcci√≥n de wallet (0x...)"
        value="0x6388681e6A22F8Fc30e3150733795255D4250db1"
      />
      <button onclick="checkWebAuthnStatus()">Verificar Estado WebAuthn</button>
      <div id="statusResult"></div>
    </div>

    <div class="section">
      <h2>üéì Paso 1: Datos de Estudiante</h2>
      <input type="text" id="studentStatus" placeholder="Estado estudiante (1=activo)" value="1" />
      <input type="text" id="enrollmentYear" placeholder="A√±o de matr√≠cula" value="2025" />
      <input type="text" id="universityHash" placeholder="Hash universidad" value="12345" />
      <input type="text" id="userSecret" placeholder="Secreto usuario" value="67890" />
    </div>

    <div class="section">
      <h2>‚úÖ Paso 2: Generar Prueba ZK</h2>
      <p>Solo prueba ZK (verificaci√≥n b√°sica):</p>
      <button onclick="mintStandard()">Generar Prueba ZK</button>
      <div id="mintStandardResult"></div>
    </div>

    <div class="section">
      <h2>üîê Paso 3: Registro WebAuthn (Solo una vez)</h2>
      <p>Registra tu dispositivo biom√©trico para verificaci√≥n segura:</p>
      <button onclick="registerWebAuthn()">Registrar Dispositivo</button>
      <div id="registerResult"></div>
    </div>

    <div class="section demo-section">
      <h2>üõ°Ô∏è Paso 4: Prueba ZK + WebAuthn (Alta Seguridad)</h2>
      <p>Prueba ZK + Verificaci√≥n WebAuthn:</p>
      <button onclick="mintWithWebAuthn()">Generar Prueba ZK + WebAuthn</button>
      <div id="mintSecureResult"></div>
    </div>

    <div class="section fraud-demo">
      <h2>üö® Demo Anti-Fraude para Jueces</h2>
      <p>
        <strong>Escenario:</strong> Un atacante rob√≥ los datos ZK pero NO tiene tu dispositivo biom√©trico.
      </p>
      <button onclick="simulateFraud()">Simular Intento de Fraude</button>
      <div id="fraudResult"></div>
    </div>

    <div class="section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white">
      <h2>üé´ Paso 5: Obtener NFT de Estudiante</h2>
      <p>
        <strong>¬°Solo disponible despu√©s de mint exitoso!</strong> Obt√©n tu NFT que prueba tu estatus de
        estudiante verificado.
      </p>
      <button id="getNftButton" onclick="getNFT()" style="display: none; background: #28a745; color: white">
        üé´ Obtener Mi NFT
      </button>
      <button onclick="testNFTImage()" style="background: #6c757d; color: white; margin-left: 10px">
        üß™ Probar Imagen NFT
      </button>
      <div id="nftResult"></div>
    </div>

    <script>
      const API_BASE = "http://localhost:3001/api";
      const NFT_BASE = "http://localhost:3001"; // Base para las im√°genes NFT
      let lastMintedTokenId = null; // Variable para guardar el √∫ltimo token ID minteado

      async function checkWebAuthnStatus() {
        const userAddress = document.getElementById("userAddress").value;
        try {
          const response = await fetch(`${API_BASE}/webauthn/status/${userAddress}`);
          const data = await response.json();

          document.getElementById("statusResult").innerHTML = `
                    <div class="${data.hasCredential ? "success" : "warning"}">
                        Estado: ${
                          data.hasCredential ? "‚úÖ Dispositivo registrado" : "‚ö†Ô∏è Dispositivo no registrado"
                        }
                    </div>
                `;
        } catch (error) {
          document.getElementById(
            "statusResult"
          ).innerHTML = `<div class="error">Error: ${error.message}</div>`;
        }
      }

      async function registerWebAuthn() {
        const userAddress = document.getElementById("userAddress").value;
        if (!userAddress) {
          alert("Ingresa una direcci√≥n de wallet");
          return;
        }

        try {
          // Paso 1: Obtener challenge del servidor
          const beginResponse = await fetch(`${API_BASE}/webauthn/register/begin`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userAddress }),
          });
          const options = await beginResponse.json();

          // Paso 2: Crear credencial con WebAuthn
          const credential = await navigator.credentials.create({
            publicKey: {
              ...options,
              challenge: base64urlToUint8Array(options.challenge),
              user: {
                ...options.user,
                id: base64urlToUint8Array(options.user.id),
              },
            },
          });

          // Paso 3: Enviar credencial al servidor
          const completeResponse = await fetch(`${API_BASE}/webauthn/register/complete`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              userAddress,
              credential: {
                id: credential.id,
                response: {
                  clientDataJSON: uint8ArrayToBase64url(new Uint8Array(credential.response.clientDataJSON)),
                  publicKey: uint8ArrayToBase64url(new Uint8Array(credential.response.getPublicKey())),
                },
              },
            }),
          });

          const result = await completeResponse.json();

          document.getElementById("registerResult").innerHTML = `
                    <div class="success">
                        ‚úÖ Dispositivo registrado exitosamente!<br>
                        ID: ${result.credentialId}
                    </div>
                `;
        } catch (error) {
          document.getElementById(
            "registerResult"
          ).innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
          console.error("WebAuthn registration error:", error);
        }
      }

      async function mintStandard() {
        const data = getStudentData();
        try {
          const response = await fetch(`${API_BASE}/mint`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          const result = await response.json();

          document.getElementById("mintStandardResult").innerHTML = `
                    <div class="${result.success ? "success" : "error"}">
                        <strong>Resultado:</strong> ${result.success ? "‚úÖ Badge minteado" : "‚ùå Error"}<br>
                        <strong>Seguridad:</strong> ${result.securityLevel || "STANDARD"}<br>
                        ${
                          result.txHash
                            ? `<strong>TX:</strong> <a href="${
                                result.blockscoutUrl
                              }" target="_blank">${result.txHash.slice(0, 10)}...</a><br>`
                            : ""
                        }
                        ${result.tokenId ? `<strong>Token ID:</strong> ${result.tokenId}` : ""}
                        ${result.error ? `<strong>Error:</strong> ${result.error}` : ""}
                    </div>
                `;

          // Mostrar bot√≥n de NFT si el mint fue exitoso
          if (result.success) {
            lastMintedTokenId = result.tokenId; // Guardar el token ID
            document.getElementById("getNftButton").style.display = "inline-block";
            document.getElementById("nftResult").innerHTML = `
                        <div class="info">
                            üéâ ¬°Badge minteado exitosamente! Ahora puedes obtener tu NFT de estudiante.
                        </div>
                    `;
          }
        } catch (error) {
          document.getElementById(
            "mintStandardResult"
          ).innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
        }
      }

      async function mintWithWebAuthn() {
        const userAddress = document.getElementById("userAddress").value;
        const data = getStudentData();

        try {
          // Paso 1: Obtener challenge para autenticaci√≥n
          const beginResponse = await fetch(`${API_BASE}/webauthn/authenticate/begin`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userAddress }),
          });

          if (!beginResponse.ok) {
            const error = await beginResponse.json();
            throw new Error(error.error);
          }

          const options = await beginResponse.json();

          // Paso 2: Autenticar con WebAuthn
          const credential = await navigator.credentials.get({
            publicKey: {
              ...options,
              challenge: base64urlToUint8Array(options.challenge),
              allowCredentials: options.allowCredentials.map((cred) => ({
                ...cred,
                id: base64urlToUint8Array(cred.id),
              })),
            },
          });

          // Paso 3: Mint con verificaci√≥n WebAuthn
          const mintResponse = await fetch(`${API_BASE}/mint`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              ...data,
              requireWebAuthn: true,
              webAuthnCredential: {
                id: credential.id,
                response: {
                  clientDataJSON: uint8ArrayToBase64url(new Uint8Array(credential.response.clientDataJSON)),
                  authenticatorData: uint8ArrayToBase64url(
                    new Uint8Array(credential.response.authenticatorData)
                  ),
                  signature: uint8ArrayToBase64url(new Uint8Array(credential.response.signature)),
                },
              },
            }),
          });

          const result = await mintResponse.json();

          document.getElementById("mintSecureResult").innerHTML = `
                    <div class="${result.success ? "success" : "error"}">
                        <strong>Resultado:</strong> ${
                          result.success ? "‚úÖ Badge minteado con alta seguridad" : "‚ùå Error"
                        }<br>
                        <strong>ZK Verificada:</strong> ${result.verified ? "‚úÖ" : "‚ùå"}<br>
                        <strong>WebAuthn Verificada:</strong> ${result.webAuthnVerified ? "‚úÖ" : "‚ùå"}<br>
                        <strong>Nivel de Seguridad:</strong> ${result.securityLevel}<br>
                        ${
                          result.txHash
                            ? `<strong>TX:</strong> <a href="${
                                result.blockscoutUrl
                              }" target="_blank">${result.txHash.slice(0, 10)}...</a><br>`
                            : ""
                        }
                        ${result.tokenId ? `<strong>Token ID:</strong> ${result.tokenId}` : ""}
                        ${result.error ? `<strong>Error:</strong> ${result.error}` : ""}
                    </div>
                `;

          // Mostrar bot√≥n de NFT si el mint fue exitoso
          if (result.success) {
            lastMintedTokenId = result.tokenId; // Guardar el token ID
            document.getElementById("getNftButton").style.display = "inline-block";
            document.getElementById("nftResult").innerHTML = `
                        <div class="success">
                            üéâ ¬°Badge minteado con ALTA SEGURIDAD! Ahora puedes obtener tu NFT de estudiante.
                        </div>
                    `;
          }
        } catch (error) {
          document.getElementById(
            "mintSecureResult"
          ).innerHTML = `<div class="error">‚ùå Error WebAuthn: ${error.message}</div>`;
        }
      }

      async function simulateFraud() {
        const userAddress = document.getElementById("userAddress").value;

        try {
          const response = await fetch(`${API_BASE}/demo-fraud`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              userAddress,
              stolenCredential: "datos_robados_zkp",
            }),
          });

          const result = await response.json();

          document.getElementById("fraudResult").innerHTML = `
                    <div class="warning">
                        <h3>üö® Resultado del Intento de Fraude:</h3>
                        <strong>Fraude Detectado:</strong> ${result.fraudDetected ? "‚úÖ S√ç" : "‚ùå NO"}<br>
                        <strong>Fraude Exitoso:</strong> ${
                          result.fraudSuccess ? "‚ùå S√ç (MALO)" : "‚úÖ NO (BUENO)"
                        }<br>
                        <strong>WebAuthn Previno Fraude:</strong> ${
                          result.details?.webAuthnPrevented ? "‚úÖ S√ç" : "‚ùå NO"
                        }<br>
                        <p><strong>Explicaci√≥n:</strong> ${result.message}</p>
                        <div style="background: #f0f0f0; padding: 10px; border-radius: 4px;">
                            <strong>Para los Jueces:</strong> Aunque el atacante tenga los datos ZK v√°lidos, 
                            WebAuthn requiere el dispositivo f√≠sico original (huella dactilar, Face ID, etc.). 
                            Sin el dispositivo correcto, el fraude es imposible.
                        </div>
                    </div>
                `;
        } catch (error) {
          document.getElementById(
            "fraudResult"
          ).innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
        }
      }

      function getStudentData() {
        return {
          userAddress: document.getElementById("userAddress").value,
          studentStatus: document.getElementById("studentStatus").value,
          enrollmentYear: document.getElementById("enrollmentYear").value,
          universityHash: document.getElementById("universityHash").value,
          userSecret: document.getElementById("userSecret").value,
        };
      }

      // Funciones helper para conversi√≥n base64url
      function base64urlToUint8Array(base64url) {
        const base64 = base64url.replace(/-/g, "+").replace(/_/g, "/");
        const padded = base64.padEnd(base64.length + ((4 - (base64.length % 4)) % 4), "=");
        const binary = atob(padded);
        return new Uint8Array(binary.split("").map((char) => char.charCodeAt(0)));
      }

      function uint8ArrayToBase64url(uint8Array) {
        const base64 = btoa(String.fromCharCode(...uint8Array));
        return base64.replace(/\+/g, "-").replace(/\//g, "_").replace(/=/g, "");
      }

      // Funci√≥n para obtener NFT (simple, solo muestra la imagen)
      async function getNFT() {
        try {
          document.getElementById("nftResult").innerHTML = `
                    <div class="info">üîÑ Generando tu NFT de estudiante...</div>
                `;

          // Obtener informaci√≥n del √∫ltimo mint para conseguir el token ID
          const contractInfo = await fetch(`${API_BASE}/contract-info`);
          const contractData = await contractInfo.json();

          // Simular generaci√≥n del NFT
          setTimeout(() => {
            const tokenId = lastMintedTokenId || Math.floor(Math.random() * 1000); // Usar el token ID real o uno aleatorio

            document.getElementById("nftResult").innerHTML = `
                        <div class="success">
                            <h3>üé´ ¬°Tu NFT de Estudiante!</h3>
                            <div id="nftImageContainer" style="margin: 10px 0;">
                                <div style="display: flex; align-items: center; justify-content: center; min-height: 200px; background: #f8f9fa; border-radius: 10px; border: 2px solid #28a745;">
                                    <div>üîÑ Cargando imagen NFT...</div>
                                </div>
                            </div>
                            <br>
                            <strong>üéì ZK-Scholar Student Badge</strong><br>
                            <strong>üõ°Ô∏è Credencial Verificada con ZK + WebAuthn</strong><br>
                            <strong>üåê Red: Polkadot Paseo</strong><br>
                            <strong>üìÖ Fecha: ${new Date().toLocaleDateString()}</strong><br>
                            <br>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0; text-align: left;">
                                <h4>üì± Para agregar a MetaMask:</h4>
                                <p><strong>Direcci√≥n del Contrato:</strong><br>
                                <code style="background: #e9ecef; padding: 4px; border-radius: 4px; font-family: monospace;">${
                                  contractData.address
                                }</code>
                                <button onclick="copyToClipboard('${
                                  contractData.address
                                }')" style="margin-left: 5px; padding: 2px 8px;">üìã Copiar</button></p>
                                
                                <p><strong>Token ID:</strong><br>
                                <code style="background: #e9ecef; padding: 4px; border-radius: 4px; font-family: monospace;">${tokenId}</code>
                                <button onclick="copyToClipboard('${tokenId}')" style="margin-left: 5px; padding: 2px 8px;">üìã Copiar</button></p>
                                
                                <p><strong>Red:</strong> Polkadot Paseo Testnet (Chain ID: 420420422)</p>
                                
                                <div style="margin-top: 15px;">
                                    <button onclick="addToMetaMask('${contractData.address}', '${tokenId}')" 
                                            style="background: #ff6600; color: white; padding: 10px 15px; border: none; border-radius: 5px; margin-right: 10px;">
                                        ü¶ä Agregar a MetaMask
                                    </button>
                                    <button onclick="showManualInstructions('${
                                      contractData.address
                                    }', '${tokenId}')" 
                                            style="background: #6c757d; color: white; padding: 10px 15px; border: none; border-radius: 5px;">
                                        üìù Instrucciones Manuales
                                    </button>
                                </div>
                            </div>
                            <br>
                            <small>Este NFT representa tu credencial estudiantil verificada de forma segura.</small>
                        </div>
                    `;

            // Cargar la imagen despu√©s de crear el contenedor
            loadNFTImage(tokenId);

            // Ocultar el bot√≥n despu√©s de obtener el NFT
            document.getElementById("getNftButton").style.display = "none";
          }, 2000);
        } catch (error) {
          document.getElementById("nftResult").innerHTML = `
                    <div class="error">‚ùå Error generando NFT: ${error.message}</div>
                `;
        }
      }

      // Funci√≥n de prueba para verificar la imagen NFT
      function testNFTImage() {
        document.getElementById("nftResult").innerHTML = `
                <div class="info">
                    <h3>üß™ Prueba de Imagen NFT</h3>
                    <p>Probando cargar imagen desde: <code>${NFT_BASE}/nft/nft.png</code></p>
                    <div id="nftImageContainer" style="margin: 10px 0;">
                        <div style="display: flex; align-items: center; justify-content: center; min-height: 200px; background: #f8f9fa; border-radius: 10px; border: 2px solid #007bff;">
                            <div>üîÑ Probando carga de imagen...</div>
                        </div>
                    </div>
                    <p><strong>Check de URLs:</strong></p>
                    <p>‚Ä¢ API Base: <code>${API_BASE}</code></p>
                    <p>‚Ä¢ NFT Base: <code>${NFT_BASE}</code></p>
                    <p>‚Ä¢ URL de imagen: <code>${NFT_BASE}/nft/nft.png</code></p>
                    <p><a href="${NFT_BASE}/nft/nft.png" target="_blank">üîó Abrir imagen en nueva pesta√±a</a></p>
                </div>
            `;

        // Cargar imagen de prueba
        loadNFTImage("TEST");
      }

      // Funci√≥n para cargar la imagen NFT con manejo de errores
      function loadNFTImage(tokenId) {
        const container = document.getElementById("nftImageContainer");
        if (!container) return;

        console.log("üñºÔ∏è Intentando cargar imagen NFT desde:", `${NFT_BASE}/nft/nft.png`);

        // Crear imagen con manejo de eventos
        const img = new Image();

        img.onload = function () {
          console.log("‚úÖ Imagen NFT cargada exitosamente");
          container.innerHTML = `
                    <img src="${NFT_BASE}/nft/nft.png" 
                         alt="NFT Estudiante #${tokenId}" 
                         style="max-width: 200px; max-height: 200px; border-radius: 10px; border: 2px solid #28a745; object-fit: contain;">
                `;
        };

        img.onerror = function () {
          console.error("‚ùå Error cargando imagen NFT, usando imagen de respaldo");
          container.innerHTML = `
                    <div style="width: 200px; height: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; border: 2px solid #28a745; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 10px;">üéì</div>
                        <div style="font-size: 16px; font-weight: bold;">ZK-Scholar</div>
                        <div style="font-size: 12px;">Student Badge</div>
                        <div style="font-size: 10px; margin-top: 8px;">#${tokenId}</div>
                    </div>
                `;
        };

        // Timeout para imagen que tarda mucho en cargar
        setTimeout(() => {
          if (!img.complete) {
            console.warn("‚ö†Ô∏è Imagen NFT tarda mucho en cargar, usando respaldo");
            img.onerror();
          }
        }, 5000);

        // Iniciar carga
        img.src = `${NFT_BASE}/nft/nft.png`;
      }

      // Funci√≥n para mostrar instrucciones manuales detalladas
      function showManualInstructions(contractAddress, tokenId) {
        const instructions = `
üì± INSTRUCCIONES MANUALES PARA METAMASK

üîß Paso 1: Verificar Red
‚Ä¢ Aseg√∫rate de estar en "Paseo PassetHub"
‚Ä¢ Chain ID: 420420422

üì¶ Paso 2: Importar NFT
‚Ä¢ Abre MetaMask
‚Ä¢ Ve a la pesta√±a "NFTs"
‚Ä¢ Haz clic en "Importar NFT"

üìã Paso 3: Datos del NFT
‚Ä¢ Direcci√≥n del contrato: ${contractAddress}
‚Ä¢ Token ID: ${tokenId}
‚Ä¢ Haz clic en "Agregar"

‚úÖ ¬°Listo! Tu NFT deber√≠a aparecer en MetaMask
            `;

        alert(instructions);

        // Copiar autom√°ticamente la direcci√≥n del contrato
        copyToClipboard(contractAddress);
      }

      // Funci√≥n para copiar al portapapeles
      function copyToClipboard(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            alert("‚úÖ Copiado al portapapeles: " + text);
          })
          .catch((err) => {
            console.error("Error copiando: ", err);
            alert("‚ùå Error copiando al portapapeles");
          });
      }

      // Funci√≥n para agregar NFT a MetaMask autom√°ticamente
      async function addToMetaMask(contractAddress, tokenId) {
        try {
          if (typeof window.ethereum === "undefined") {
            alert("‚ùå MetaMask no detectado");
            return;
          }

          // Primero verificar que estemos en la red correcta
          const chainId = await window.ethereum.request({ method: "eth_chainId" });
          if (chainId !== "0x1911f0a6") {
            const changeNetwork = confirm(
              "‚ö†Ô∏è Necesitas estar en la red Paseo PassetHub.\n¬øQuieres cambiar autom√°ticamente?"
            );
            if (changeNetwork) {
              await switchToPolkadotNetwork();
            } else {
              return;
            }
          }

          // Intentar agregar el NFT con informaci√≥n m√°s completa
          const wasAdded = await window.ethereum.request({
            method: "wallet_watchAsset",
            params: {
              type: "ERC721",
              options: {
                address: contractAddress,
                tokenId: tokenId.toString(), // Asegurar que es string
                name: `ZK-Scholar Student Badge #${tokenId}`,
                description: "Credencial estudiantil verificada con Zero-Knowledge Proofs y WebAuthn",
                image: `http://localhost:3001/nft/nft.png`,
              },
            },
          });

          if (wasAdded) {
            alert("üéâ ¬°NFT agregado a MetaMask exitosamente!");
          } else {
            // Si el m√©todo autom√°tico falla, dar instrucciones manuales
            const manualInstructions = `‚ö†Ô∏è El m√©todo autom√°tico no funcion√≥.\n\nüìù Instrucciones manuales:\n1. Ve a MetaMask ‚Üí NFTs ‚Üí "Importar NFT"\n2. Direcci√≥n del contrato: ${contractAddress}\n3. Token ID: ${tokenId}\n4. Haz clic en "Agregar"\n\n¬øQuieres que copie la direcci√≥n del contrato al portapapeles?`;

            const copyAddress = confirm(manualInstructions);
            if (copyAddress) {
              await copyToClipboard(contractAddress);
            }
          }
        } catch (error) {
          console.error("Error agregando a MetaMask:", error);

          // Dar instrucciones manuales m√°s detalladas en caso de error
          const errorMessage = `‚ùå Error autom√°tico: ${error.message}\n\nüìù Soluci√≥n manual:\n1. Abre MetaMask\n2. Ve a la pesta√±a "NFTs"\n3. Haz clic en "Importar NFT"\n4. Pega esta direcci√≥n: ${contractAddress}\n5. Token ID: ${tokenId}\n6. Confirma\n\n¬øCopiar direcci√≥n del contrato?`;

          const copyForManual = confirm(errorMessage);
          if (copyForManual) {
            try {
              await copyToClipboard(contractAddress);
              alert("‚úÖ Direcci√≥n copiada al portapapeles");
            } catch (copyError) {
              console.error("Error copiando:", copyError);
            }
          }
        }
      }

      // Funci√≥n para cambiar a la red Polkadot Paseo
      async function switchToPolkadotNetwork() {
        try {
          // Intentar cambiar a la red Polkadot Paseo
          await window.ethereum.request({
            method: "wallet_switchEthereumChain",
            params: [{ chainId: "0x190f1b46" }], // 420420422 en hexadecimal
          });
          alert("‚úÖ Cambiado a red Paseo PassetHub exitosamente");
        } catch (switchError) {
          // Si la red no existe, agregarla
          if (switchError.code === 4902) {
            try {
              await window.ethereum.request({
                method: "wallet_addEthereumChain",
                params: [
                  {
                    chainId: "0x190f1b46",
                    chainName: "Paseo PassetHub",
                    nativeCurrency: {
                      name: "PAS",
                      symbol: "PAS",
                      decimals: 18,
                    },
                    rpcUrls: ["https://testnet-passet-hub-eth-rpc.polkadot.io"],
                    blockExplorerUrls: ["https://blockscout-passet-hub.parity-testnet.parity.io"],
                  },
                ],
              });
              alert("‚úÖ Red Paseo PassetHub agregada y activada exitosamente");
            } catch (addError) {
              console.error("Error agregando red:", addError);
              alert("‚ùå No se pudo agregar la red Paseo PassetHub a MetaMask: " + addError.message);
            }
          } else {
            console.error("Error cambiando red:", switchError);
            alert("‚ùå Error cambiando a red Paseo PassetHub: " + switchError.message);
          }
        }
      }

      // Verificar estado al cargar la p√°gina
      window.addEventListener("load", () => {
        checkWebAuthnStatus();
      });
    </script>
  </body>
</html>
